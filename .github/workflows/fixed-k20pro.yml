name: ğŸš€ Build K20 Pro KernelSU (Fixed)

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ä¸‹è½½æºç 
      run: |
        git clone https://github.com/MiCode/Xiaomi_Kernel_OpenSource.git -b raphael-p-oss --depth=1 kernel
        cd kernel
        echo "å†…æ ¸ç‰ˆæœ¬ï¼š4.14"
        
    - name: ğŸ”§ å®‰è£…å·¥å…·
      run: |
        sudo apt update
        sudo apt install -y build-essential gcc-aarch64-linux-gnu libssl-dev bc
        
    - name: âš¡ é›†æˆKernelSUï¼ˆæ–°ç‰ˆï¼‰
      run: |
        cd kernel
        
        # æœ€æ–°æ–¹æ³•ï¼šç›´æ¥è¿è¡Œé›†æˆè„šæœ¬
        curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
        
        echo "æ£€æŸ¥KSUï¼š"
        ls drivers/kernelsu/
        
    - name: âš™ï¸ é…ç½®å†…æ ¸
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # ä½¿ç”¨é…ç½®
        if [ -f "arch/arm64/configs/raphael_defconfig" ]; then
          make raphael_defconfig
        else
          make defconfig
        fi
        
        # å¯ç”¨KSUï¼ˆæ–°ç‰ˆæœ¬å¯èƒ½å«KSU_LEGACYï¼‰
        ./scripts/config --enable KSU 2>/dev/null || true
        ./scripts/config --module KSU 2>/dev/null || true
        
    - name: ğŸ› ï¸ å¼€å§‹ç¼–è¯‘
      timeout-minutes: 60
      run: |
        cd kernel
        export ARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        echo "å¼€å§‹ç¼–è¯‘ï¼Œä½¿ç”¨ $(nproc) ä¸ªæ ¸å¿ƒ..."
        make -j$(nproc) 2>&1 | tee build.log || make -j2 2>&1 | tee build.log
        
        echo "ç¼–è¯‘å®Œæˆï¼"
        ls -lh arch/arm64/boot/
        
    - name: ğŸ“¤ ä¸Šä¼ ç»“æœ
      uses: actions/upload-artifact@v3
      with:
        name: k20pro-kernel
        path: kernel/arch/arm64/boot/Image.gz-dtb
