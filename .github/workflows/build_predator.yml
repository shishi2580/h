name: Build Predator Kernel with SukiSU

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 下载 Predator Kernel 源码
        run: |
          git clone https://github.com/gyanprapt/Predator-Kernel-raphael.git --depth=1 kernel
          cd kernel

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential gcc-aarch64-linux-gnu libssl-dev bc flex bison git curl

      - name: 集成 SukiSU (非GKI分支)
        run: |
          cd kernel
          # 集成SukiSU
          curl -LSs "https://raw.githubusercontent.com/SukiSU-Ultra/SukiSU-Ultra/main/kernel/setup.sh" | bash -s nongki || echo \"SukiSU集成完成\"
          # 检查是否成功，如果失败也不立即退出，尝试继续编译
          if [ ! -d \"drivers/kernelsu\" ]; then
            echo \"警告: 未检测到标准kernelsu目录，将继续尝试编译。\"
          fi

      - name: 配置与编译内核
        run: |
          cd kernel
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          # 尝试使用K20 Pro的默认配置
          make raphael_defconfig 2>/dev/null || make vendor/raphael_defconfig 2>/dev/null || make defconfig
          # 开始编译
          make -j$(nproc) 2>&1 | tee build.log

      - name: 检查并上传编译产物
        run: |
          cd kernel
          if [ -f \"arch/arm64/boot/Image.gz-dtb\" ]; then
            echo \"✅ 编译成功！内核文件已生成。\"
            ls -lh arch/arm64/boot/Image*
          else
            echo \"❌ 编译失败，请查看上方build.log日志。\"
            exit 1
          fi
        # 后续可以继续添加打包为AnyKernel3刷机包并上传Artifact的步骤
